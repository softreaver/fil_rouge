<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" type="text/css" href="../css/main.css">
    <link rel="stylesheet" href="../css/bootstrap.css">
    <title>Document</title>
</head>

<body>
    <h1>Super Chat</h1>
    <div class="row">
        <div class="col-3">
          <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist" aria-orientation="vertical">
            <a class="nav-link active" id="v-pills-default-tab" data-toggle="pill" href="#v-pills-default" role="tab" aria-controls="v-pills-default" aria-selected="true">default</a>
            <!-- <a class="nav-link" id="v-pills-profile-tab" data-toggle="pill" href="#v-pills-profile" role="tab" aria-controls="v-pills-profile" aria-selected="false">Channel name</a> -->
          </div>
        </div>
        <div class="col-9">
          <div class="tab-content" id="v-pills-tabContent">
            <div class="tab-pane fade show active" id="v-pills-default" role="tabpanel" aria-labelledby="v-pills-default">
                <div class="messages-list" id="messages-list-default">
                    <!-- HERE - List of all messages -->
                </div>
            </div>
            <!--
            <div class="tab-pane fade" id="v-pills-channel-name" role="tabpanel" aria-labelledby="v-pills-channel-name">
                <div class="messages-list" id="messages-list-channel-name">
                    HERE - List of all messages
                </div>
            </div>
            -->
          </div>
        </div>
      </div>

    <form id="send-message-form" method="POST">
        <input type="text" name="message" id="message-input" autocomplete="off">
        <button type="submit">Envoyer</button>
    </form>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        var audio = new Audio('../sounds/newMessage.mp3');

        var socket = io.connect(':3000');
        var myPseudo = null;
        var myChannelList = ['default'];
        socket.on('connect_error', error => {
            console.log(error);
        });

        socket.on('welcomeBack', user => {
            myPseudo = user.pseudo;
            myChannelList = user.channelList;
        });

        socket.on('whoAreYou', () => {
            let check = false;
            while (!check) {
                myPseudo = prompt('Entrez un pseudo (au moins 3 caratcères) :', '');

                // Check if pseudo is correct
                if (myPseudo && myPseudo.trim().length >= 3) {
                    check = true;
                } else {
                    alert("Merci d'entrer un pseudo correcte !");
                }
            }

            socket.emit('pseudo', myPseudo);
        });

        socket.on('connection', pseudo => {
            writeMessage({
                text: "Vient de se connecter.",
                pseudo: pseudo
            }, true);
        });

        socket.on('message', message => {
            if (typeof message !== 'undefined')
                if (typeof message.text !== 'undefined' && typeof message.pseudo !== 'undefined' && typeof message.channel !== 'undefined')
                    writeMessage(message);
        });

        socket.on('disconnection', pseudo => {
            writeMessage({
                text: "S'est déconnecté.",
                pseudo: pseudo
            }, true);
        });

        function writeMessage(message, isNotification = false) {
            let messageElt = document.createElement('p');
            messageElt.innerHTML = `
                <span class="pseudo">${ message.pseudo}</span> ${(isNotification) ? '' : ': '}${message.text}
            `;
            if (isNotification)
                messageElt.className = "notification";
            else
                if(message.pseudo !== myPseudo)
                    audio.play();

            let channel = message.channel.replace(/ /g, '-');
            let messagesListElt = document.getElementById('messages-list-' + channel);
            let scrollToBottom = false;

            if(messagesListElt.scrollTop + messagesListElt.clientHeight - messagesListElt.scrollHeight > -10 &&
            messagesListElt.scrollTop + messagesListElt.clientHeight - messagesListElt.scrollHeight < 10)
                scrollToBottom = true;

            messagesListElt.appendChild(messageElt);
            
            if(scrollToBottom) 
                messagesListElt.scrollTo(0, messagesListElt.scrollHeight - messagesListElt.clientHeight);

        }

        document.getElementById('send-message-form').addEventListener('submit', event => {
            event.preventDefault();
            let inputElt = document.getElementById('message-input');

            if (inputElt.value.trim().length > 0) {
                if(inputElt.value.indexOf('/') === 0 && inputElt.value.length > 1) {
                    socket.emit('joinChannel', inputElt.value.substr(1));
                } else if (inputElt.value.indexOf('/') === 0) {
                    socket.emit('checkSocket');
                } else {
                    // retrive active channel name
                    let channel = document.querySelector(`.nav-link.active`).value;
                    socket.emit('message', inputElt.value, channel);
                    writeMessage({
                        text: inputElt.value,
                        pseudo: myPseudo,
                        channel: channel
                    });
                }
                inputElt.value = '';
            }
                
        });
    </script>
</body>

</html>